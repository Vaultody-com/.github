name: Agent Developer (Reusable)

on:
  workflow_call:
    inputs:
      repo:
        description: 'Target repository (owner/repo)'
        type: string
        required: true
      issue_number:
        description: 'Issue number to implement'
        type: string
        required: true
      base_branch:
        description: 'Base branch to branch from'
        type: string
        default: 'main'
    secrets:
      ORG_ADMIN_TOKEN:
        required: true
      ANTHROPIC_API_KEY:
        required: true

jobs:
  developer-agent:
    name: Developer Agent - Implement Issue
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      GH_TOKEN: ${{ secrets.ORG_ADMIN_TOKEN }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      REPO: ${{ inputs.repo }}
      ISSUE_NUMBER: ${{ inputs.issue_number }}
      BASE_BRANCH: ${{ inputs.base_branch }}
      FEATURE_BRANCH: feature/issue-${{ inputs.issue_number }}
    steps:
      - name: Retrieve issue details
        id: issue
        run: |
          ISSUE_DATA=$(gh api "repos/${REPO}/issues/${ISSUE_NUMBER}")
          ISSUE_TITLE=$(echo "${ISSUE_DATA}" | jq -r '.title')
          ISSUE_BODY=$(echo "${ISSUE_DATA}" | jq -r '.body // ""')
          echo "title=${ISSUE_TITLE}" >> "${GITHUB_OUTPUT}"
          echo "ISSUE_TITLE=${ISSUE_TITLE}" >> "${GITHUB_ENV}"
          echo "${ISSUE_BODY}" > /tmp/issue-body.txt
          echo "Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}"

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repo }}
          token: ${{ secrets.ORG_ADMIN_TOKEN }}
          ref: ${{ inputs.base_branch }}
          fetch-depth: 0

      - name: Checkout agent-prompts from .github repo
        uses: actions/checkout@v4
        with:
          repository: Vaultody-com/.github
          token: ${{ secrets.ORG_ADMIN_TOKEN }}
          path: .agent-system

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build repository tree (src/ only)
        run: |
          find src/ -type f 2>/dev/null | sort > /tmp/repo-tree.txt || echo "(no src/ directory found)" > /tmp/repo-tree.txt
          echo "Repository src/ tree written:"
          cat /tmp/repo-tree.txt

      - name: Build src file contents
        run: |
          echo "" > /tmp/src-contents.txt
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "=== ${file} ===" >> /tmp/src-contents.txt
              cat "${file}" >> /tmp/src-contents.txt
              echo "" >> /tmp/src-contents.txt
            fi
          done < /tmp/repo-tree.txt
          echo "Src contents size: $(wc -c < /tmp/src-contents.txt) bytes"

      - name: Create or reset feature branch
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          if git ls-remote --exit-code --heads origin "${FEATURE_BRANCH}"; then
            git checkout "${FEATURE_BRANCH}"
            git reset --hard "origin/${BASE_BRANCH}"
          else
            git checkout -b "${FEATURE_BRANCH}"
          fi

      - name: Install Anthropic SDK
        run: npm install -g @anthropic-ai/sdk

      - name: Write agent script
        run: |
          cat > /tmp/agent.js << 'AGENTEOF'
          const Anthropic = require('/usr/local/lib/node_modules/@anthropic-ai/sdk');
          const fs = require('fs');
          const path = require('path');

          async function main() {
            const client = new Anthropic.default();
            const issueNumber = process.env.ISSUE_NUMBER;
            const issueTitle = process.env.ISSUE_TITLE;
            const issueBody = fs.readFileSync('/tmp/issue-body.txt', 'utf8');
            const srcContents = fs.readFileSync('/tmp/src-contents.txt', 'utf8');
            const repoTree = fs.readFileSync('/tmp/repo-tree.txt', 'utf8');
            const devPrompt = fs.readFileSync('.agent-system/agent-prompts/developer.md', 'utf8');

            const prompt = devPrompt + '\n\n---\n' +
              'ISSUE #' + issueNumber + ': ' + issueTitle + '\n\n' +
              issueBody + '\n\n' +
              'REPOSITORY SRC FILES:\n' + repoTree + '\n\n' +
              'SRC FILE CONTENTS:\n' + srcContents + '\n\n' +
              'IMPORTANT: Respond with the complete new content for each file that needs to change.\n' +
              'Use this EXACT format for each file:\n' +
              'FILE: src/path/to/file.ts\n' +
              '```\n' +
              '<complete new file content here>\n' +
              '```\n' +
              'Only include files under src/ that need to be modified.';

            const response = await client.messages.create({
              model: 'claude-sonnet-4-5',
              max_tokens: 4096,
              messages: [{ role: 'user', content: prompt }]
            });

            const output = response.content[0].text;
            console.log('=== Claude Response ===');
            console.log(output);

            // Parse FILE: blocks and write them
            const fileRegex = /FILE: (src\/[^\n]+)\n```(?:\w+)?\n([\s\S]*?)```/g;
            let match;
            let filesWritten = 0;
            while ((match = fileRegex.exec(output)) !== null) {
              const filePath = match[1].trim();
              const content = match[2];
              const dir = path.dirname(filePath);
              if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
              fs.writeFileSync(filePath, content);
              console.log('Written: ' + filePath);
              filesWritten++;
            }
            console.log('Files written: ' + filesWritten);
            if (filesWritten === 0) {
              console.error('ERROR: No files were written');
              process.exit(1);
            }
            fs.writeFileSync('/tmp/developer-report.txt', output);
          }

          main().catch(e => { console.error(e); process.exit(1); });
          AGENTEOF
          echo 'Agent script written'

      - name: Run Developer Agent
        run: node /tmp/agent.js

      - name: Show git status after Claude
        run: |
          git status
          git diff --stat

      - name: Enforce path boundaries (src/** only)
        run: |
          UNAUTHORIZED=$(git diff --name-only HEAD | grep -vE '^src/' || true)
          if [ -n "${UNAUTHORIZED}" ]; then
            echo "FAIL: Unauthorized files modified outside src/:"
            echo "${UNAUTHORIZED}"
            exit 1
          fi
          echo "Path boundary check: PASS (only src/** modified)"

      - name: Commit and push feature branch
        run: |
          git add src/
          if git diff --cached --quiet; then
            echo "No changes to commit - agent made no modifications"
            exit 1
          fi
          git commit -m "feat(#${ISSUE_NUMBER}): implement ${ISSUE_TITLE}"
          git push origin "${FEATURE_BRANCH}"

      - name: Open Pull Request
        id: pr
        run: |
          EXISTING_PR=$(gh pr list --repo "${REPO}" --head "${FEATURE_BRANCH}" --json number --jq '.[0].number' 2>/dev/null)
          if [ -n "${EXISTING_PR}" ]; then
            echo "PR already exists: #${EXISTING_PR}"
            echo "pr_number=${EXISTING_PR}" >> "${GITHUB_OUTPUT}"
          else
            printf 'Fixes #%s\n\n## Developer Agent Report\n\n%s' \
              "${ISSUE_NUMBER}" "$(cat /tmp/developer-report.txt)" > /tmp/pr-body.txt
            PR_URL=$(gh pr create \
              --repo "${REPO}" \
              --head "${FEATURE_BRANCH}" \
              --base "${BASE_BRANCH}" \
              --title "Implement issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}" \
              --body-file /tmp/pr-body.txt)
            echo "PR created: ${PR_URL}"
            PR_NUMBER=$(echo "${PR_URL}" | grep -oE '[0-9]+$')
            echo "pr_number=${PR_NUMBER}" >> "${GITHUB_OUTPUT}"
          fi

      - name: Post agent report as PR comment
        run: |
          PR_NUMBER=${{ steps.pr.outputs.pr_number }}
          if [ -n "${PR_NUMBER}" ]; then
            printf '## Developer Agent Report\n\n%s' "$(cat /tmp/developer-report.txt)" > /tmp/comment-body.txt
            gh pr comment "${PR_NUMBER}" \
              --repo "${REPO}" \
              --body-file /tmp/comment-body.txt
          fi
