name: Agent Tests (Reusable)

on:
  workflow_call:
    inputs:
      repo:
        description: 'Target repository (owner/repo)'
        type: string
        required: true
      issue_number:
        description: 'Issue number'
        type: string
        required: true
      pr_number:
        description: 'PR number to comment on'
        type: string
        required: true
      mode:
        description: 'Test mode: unit or integration'
        type: string
        required: true
    secrets:
      ORG_ADMIN_TOKEN:
        required: true
      ANTHROPIC_API_KEY:
        required: true

jobs:
  test-agent:
    name: Test Agent â€” ${{ inputs.mode }} tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      GH_TOKEN: ${{ secrets.ORG_ADMIN_TOKEN }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      REPO: ${{ inputs.repo }}
      ISSUE_NUMBER: ${{ inputs.issue_number }}
      PR_NUMBER: ${{ inputs.pr_number }}
      MODE: ${{ inputs.mode }}
      FEATURE_BRANCH: feature/issue-${{ inputs.issue_number }}
    steps:
      - name: Validate mode input
        run: |
          if [ "${MODE}" != "unit" ] && [ "${MODE}" != "integration" ]; then
            echo "FAIL: Invalid mode '${MODE}'. Must be 'unit' or 'integration'."
            exit 1
          fi
          echo "Mode: ${MODE}"

      - name: Checkout feature branch
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repo }}
          token: ${{ secrets.ORG_ADMIN_TOKEN }}
          ref: feature/issue-${{ inputs.issue_number }}
          fetch-depth: 0

      - name: Checkout agent-prompts from .github repo
        uses: actions/checkout@v4
        with:
          repository: Vaultody-com/.github
          token: ${{ secrets.ORG_ADMIN_TOKEN }}
          path: .agent-system

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Retrieve issue details
        run: |
          ISSUE_DATA=$(gh api "repos/${REPO}/issues/${ISSUE_NUMBER}")
          ISSUE_TITLE=$(echo "${ISSUE_DATA}" | jq -r '.title')
          ISSUE_BODY=$(echo "${ISSUE_DATA}" | jq -r '.body // ""')
          echo "ISSUE_TITLE=${ISSUE_TITLE}" >> "${GITHUB_ENV}"
          echo "${ISSUE_BODY}" > /tmp/issue-body.txt

      - name: Get PR diff (src changes)
        run: |
          gh api "repos/${REPO}/pulls/${PR_NUMBER}/files" \
            --jq '.[].filename' | grep '^src/' > /tmp/changed-src-files.txt || true
          echo "Changed src files:"
          cat /tmp/changed-src-files.txt

      - name: Configure git
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

      - name: Build unit test agent input and run (Claude Code)
        if: inputs.mode == 'unit'
        run: |
          ISSUE_BODY=$(cat /tmp/issue-body.txt)
          CHANGED_FILES=$(cat /tmp/changed-src-files.txt)
          PROMPT=$(cat .agent-system/agent-prompts/unit-tests.md)
          printf '%s\n\n---\nCONTEXT:\nISSUE_NUMBER=%s\nISSUE_TITLE=%s\nREPO=%s\nFEATURE_BRANCH=%s\nPR_NUMBER=%s\nMODE=unit\n\nISSUE BODY:\n%s\n\nCHANGED SOURCE FILES:\n%s\n' \
            "${PROMPT}" "${ISSUE_NUMBER}" "${ISSUE_TITLE}" "${REPO}" "${FEATURE_BRANCH}" "${PR_NUMBER}" \
            "${ISSUE_BODY}" "${CHANGED_FILES}" > /tmp/unit-full-prompt.txt
          set +e
          claude --model claude-haiku-4-5 --max-turns 15 -p "$(cat /tmp/unit-full-prompt.txt)" > /tmp/test-report.txt 2>&1
          CLAUDE_EXIT=$?
          set -e
          echo "=== Unit Test Agent Output ==="
          cat /tmp/test-report.txt
          echo "=== Claude exit code: ${CLAUDE_EXIT} ==="
          if [ "${CLAUDE_EXIT}" -ne 0 ]; then exit ${CLAUDE_EXIT}; fi

      - name: Build integration test agent input and run (Claude Code)
        if: inputs.mode == 'integration'
        run: |
          ISSUE_BODY=$(cat /tmp/issue-body.txt)
          CHANGED_FILES=$(cat /tmp/changed-src-files.txt)
          PROMPT=$(cat .agent-system/agent-prompts/integration-tests.md)
          printf '%s\n\n---\nCONTEXT:\nISSUE_NUMBER=%s\nISSUE_TITLE=%s\nREPO=%s\nFEATURE_BRANCH=%s\nPR_NUMBER=%s\nMODE=integration\n\nISSUE BODY:\n%s\n\nCHANGED SOURCE FILES:\n%s\n' \
            "${PROMPT}" "${ISSUE_NUMBER}" "${ISSUE_TITLE}" "${REPO}" "${FEATURE_BRANCH}" "${PR_NUMBER}" \
            "${ISSUE_BODY}" "${CHANGED_FILES}" > /tmp/integration-full-prompt.txt
          set +e
          claude --model claude-haiku-4-5 --max-turns 15 -p "$(cat /tmp/integration-full-prompt.txt)" > /tmp/test-report.txt 2>&1
          CLAUDE_EXIT=$?
          set -e
          echo "=== Integration Test Agent Output ==="
          cat /tmp/test-report.txt
          echo "=== Claude exit code: ${CLAUDE_EXIT} ==="
          if [ "${CLAUDE_EXIT}" -ne 0 ]; then exit ${CLAUDE_EXIT}; fi

      - name: Enforce test path boundaries
        run: |
          UNAUTHORIZED=$(git diff --name-only HEAD | grep -vE "^(test/unit/|test/integration/|src/)" || true)
          if [ -n "${UNAUTHORIZED}" ]; then
            echo "FAIL: Unauthorized files modified outside allowed paths:"
            echo "${UNAUTHORIZED}"
            exit 1
          fi
          SRC_MODIFIED=$(git diff --name-only HEAD | grep '^src/' || true)
          if [ -n "${SRC_MODIFIED}" ]; then
            echo "FAIL: Test agent modified production files (src/**):"
            echo "${SRC_MODIFIED}"
            exit 1
          fi
          echo "Path boundary check: PASS"

      - name: Run test suite
        id: tests
        run: |
          if [ "${MODE}" = "unit" ]; then
            npm run test:unit -- --ci --json --outputFile=/tmp/jest-results.json 2>&1 | tee /tmp/test-run.log || true
          else
            npm run test:integration -- --ci --json --outputFile=/tmp/jest-results.json 2>&1 | tee /tmp/test-run.log || true
          fi
          PASSED=$(cat /tmp/jest-results.json 2>/dev/null | jq '.numPassedTests // 0')
          FAILED=$(cat /tmp/jest-results.json 2>/dev/null | jq '.numFailedTests // 0')
          TOTAL=$(cat /tmp/jest-results.json 2>/dev/null | jq '.numTotalTests // 0')
          echo "passed=${PASSED}" >> "${GITHUB_OUTPUT}"
          echo "failed=${FAILED}" >> "${GITHUB_OUTPUT}"
          echo "total=${TOTAL}" >> "${GITHUB_OUTPUT}"
          echo "Test results: ${PASSED} passed, ${FAILED} failed, ${TOTAL} total"
          if [ "${FAILED}" -gt 0 ]; then
            echo "FAIL: ${FAILED} test(s) failed"
            exit 1
          fi

      - name: Commit test files to feature branch
        run: |
          if [ "${MODE}" = "unit" ]; then
            git add "test/unit/" || true
          else
            git add "test/integration/" || true
          fi
          if git diff --cached --quiet; then
            echo "No new test files to commit"
          else
            git commit -m "test(${MODE}/#${ISSUE_NUMBER}): add ${MODE} tests"
            git push origin "${FEATURE_BRANCH}"
          fi

      - name: Post test report as PR comment
        if: always()
        run: |
          AGENT_REPORT=$(cat /tmp/test-report.txt 2>/dev/null || echo "No agent report generated")
          PASSED=${{ steps.tests.outputs.passed }}
          FAILED=${{ steps.tests.outputs.failed }}
          TOTAL=${{ steps.tests.outputs.total }}
          printf '## %s Test Agent Report\n\n%s\n\n---\n**Test Run:** %s passed / %s failed / %s total' \
            "${MODE}" "${AGENT_REPORT}" "${PASSED:-0}" "${FAILED:-0}" "${TOTAL:-0}" > /tmp/pr-comment.txt
          gh pr comment "${PR_NUMBER}" \
            --repo "${REPO}" \
            --body-file /tmp/pr-comment.txt
