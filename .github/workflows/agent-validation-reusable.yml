name: Agent Validation (Reusable)

on:
  workflow_call:
    inputs:
      repo:
        description: 'Target repository (owner/repo)'
        type: string
        required: true
      issue_number:
        description: 'Issue number'
        type: string
        required: true
      pr_number:
        description: 'PR number to comment on'
        type: string
        required: true
      mode:
        description: 'Validation mode: review | qa | perf'
        type: string
        required: true
    secrets:
      ORG_ADMIN_TOKEN:
        required: true
      ANTHROPIC_API_KEY:
        required: true

jobs:
  validation-agent:
    name: Validation Agent — ${{ inputs.mode }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      GH_TOKEN: ${{ secrets.ORG_ADMIN_TOKEN }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      REPO: ${{ inputs.repo }}
      ISSUE_NUMBER: ${{ inputs.issue_number }}
      PR_NUMBER: ${{ inputs.pr_number }}
      MODE: ${{ inputs.mode }}
      FEATURE_BRANCH: feature/issue-${{ inputs.issue_number }}
    steps:
      - name: Validate mode input
        run: |
          if [ "${MODE}" != "review" ] && [ "${MODE}" != "qa" ] && [ "${MODE}" != "perf" ]; then
            echo "FAIL: Invalid mode '${MODE}'. Must be 'review', 'qa', or 'perf'."
            exit 1
          fi
          echo "Validation mode: ${MODE}"

      - name: Checkout feature branch
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repo }}
          token: ${{ secrets.ORG_ADMIN_TOKEN }}
          ref: feature/issue-${{ inputs.issue_number }}
          fetch-depth: 0

      - name: Checkout agent-prompts from .github repo
        uses: actions/checkout@v4
        with:
          repository: Vaultody-com/.github
          token: ${{ secrets.ORG_ADMIN_TOKEN }}
          path: .agent-system

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Retrieve issue and PR details
        run: |
          ISSUE_DATA=$(gh api "repos/${REPO}/issues/${ISSUE_NUMBER}")
          echo "ISSUE_TITLE=$(echo "${ISSUE_DATA}" | jq -r '.title')" >> "${GITHUB_ENV}"
          echo "${ISSUE_DATA}" | jq -r '.body // ""' > /tmp/issue-body.txt
          gh api "repos/${REPO}/pulls/${PR_NUMBER}/files" \
            --jq '[.[] | {filename, status, additions, deletions}]' > /tmp/pr-files.json
          gh api "repos/${REPO}/issues/${PR_NUMBER}/comments" \
            --jq '[.[] | {user: .user.login, body: .body}]' > /tmp/pr-comments.json
          echo "Issue and PR details retrieved"

      # ── REVIEW MODE ─────────────────────────────────────────────────────────────────────
      - name: Run Reviewer Agent (Claude Code)
        if: inputs.mode == 'review'
        run: |
          ISSUE_BODY=$(cat /tmp/issue-body.txt)
          PR_FILES=$(cat /tmp/pr-files.json)
          PR_COMMENTS=$(cat /tmp/pr-comments.json)
          PROMPT=$(cat .agent-system/agent-prompts/reviewer.md)
          printf '%s\n\n---\nCONTEXT:\nISSUE_NUMBER=%s\nISSUE_TITLE=%s\nREPO=%s\nFEATURE_BRANCH=%s\nPR_NUMBER=%s\nMODE=review\n\nISSUE BODY:\n%s\n\nPR CHANGED FILES:\n%s\n\nEXISTING PR COMMENTS:\n%s\n' \
            "${PROMPT}" "${ISSUE_NUMBER}" "${ISSUE_TITLE}" "${REPO}" "${FEATURE_BRANCH}" "${PR_NUMBER}" \
            "${ISSUE_BODY}" "${PR_FILES}" "${PR_COMMENTS}" > /tmp/review-full-prompt.txt
          set +e
          claude --model claude-haiku-4-5 --max-turns 15 -p "$(cat /tmp/review-full-prompt.txt)" > /tmp/validation-report.txt 2>&1
          CLAUDE_EXIT=$?
          set -e
          echo "=== Reviewer Agent Output ==="
          cat /tmp/validation-report.txt
          echo "=== Claude exit code: ${CLAUDE_EXIT} ==="
          if [ "${CLAUDE_EXIT}" -ne 0 ]; then exit ${CLAUDE_EXIT}; fi
          if grep -q "Decision: CHANGES_REQUESTED" /tmp/validation-report.txt; then
            echo "REVIEWER_DECISION=CHANGES_REQUESTED" >> "${GITHUB_ENV}"
          else
            echo "REVIEWER_DECISION=APPROVED" >> "${GITHUB_ENV}"
          fi

      - name: Post review comment and request changes if needed
        if: inputs.mode == 'review'
        run: |
          printf '## Code Review Agent Report\n\n%s' "$(cat /tmp/validation-report.txt)" > /tmp/review-comment.txt
          gh pr comment "${PR_NUMBER}" \
            --repo "${REPO}" \
            --body-file /tmp/review-comment.txt
          if [ "${REVIEWER_DECISION}" = "CHANGES_REQUESTED" ]; then
            echo "Reviewer requested changes — failing step to block pipeline"
            exit 1
          fi

      # ── QA MODE ────────────────────────────────────────────────────────────────────────
      - name: Run QA Manual Agent (Claude Code)
        if: inputs.mode == 'qa'
        run: |
          ISSUE_BODY=$(cat /tmp/issue-body.txt)
          PR_COMMENTS=$(cat /tmp/pr-comments.json)
          PROMPT=$(cat .agent-system/agent-prompts/qa-manual.md)
          printf '%s\n\n---\nCONTEXT:\nISSUE_NUMBER=%s\nISSUE_TITLE=%s\nREPO=%s\nFEATURE_BRANCH=%s\nPR_NUMBER=%s\nMODE=qa\n\nISSUE BODY:\n%s\n\nALL AGENT REPORTS:\n%s\n' \
            "${PROMPT}" "${ISSUE_NUMBER}" "${ISSUE_TITLE}" "${REPO}" "${FEATURE_BRANCH}" "${PR_NUMBER}" \
            "${ISSUE_BODY}" "${PR_COMMENTS}" > /tmp/qa-full-prompt.txt
          set +e
          claude --model claude-haiku-4-5 --max-turns 15 -p "$(cat /tmp/qa-full-prompt.txt)" > /tmp/validation-report.txt 2>&1
          CLAUDE_EXIT=$?
          set -e
          echo "=== QA Manual Agent Output ==="
          cat /tmp/validation-report.txt
          echo "=== Claude exit code: ${CLAUDE_EXIT} ==="
          if [ "${CLAUDE_EXIT}" -ne 0 ]; then exit ${CLAUDE_EXIT}; fi
          if grep -q "Overall QA Decision: FAIL" /tmp/validation-report.txt; then
            echo "QA_DECISION=FAIL" >> "${GITHUB_ENV}"
          else
            echo "QA_DECISION=PASS" >> "${GITHUB_ENV}"
          fi

      - name: Post QA report comment
        if: inputs.mode == 'qa'
        run: |
          printf '## QA Manual Agent Report\n\n%s' "$(cat /tmp/validation-report.txt)" > /tmp/qa-comment.txt
          gh pr comment "${PR_NUMBER}" \
            --repo "${REPO}" \
            --body-file /tmp/qa-comment.txt
          if [ "${QA_DECISION}" = "FAIL" ]; then
            echo "QA declared FAIL — failing step to block pipeline"
            exit 1
          fi

      # ── PERFORMANCE MODE ────────────────────────────────────────────────────────────────
      - name: Check for performance criteria
        if: inputs.mode == 'perf'
        id: perf-check
        run: |
          ISSUE_BODY=$(cat /tmp/issue-body.txt)
          if echo "${ISSUE_BODY}" | grep -iE "(latency|throughput|response time|ms|req/s|requests per second|p95|p99|performance)" > /dev/null 2>&1; then
            echo "has_perf_criteria=true" >> "${GITHUB_OUTPUT}"
            echo "Performance criteria detected in issue"
          else
            echo "has_perf_criteria=false" >> "${GITHUB_OUTPUT}"
            echo "No performance criteria detected — will SKIP"
          fi

      - name: Run Performance Agent (Claude Code)
        if: inputs.mode == 'perf' && steps.perf-check.outputs.has_perf_criteria == 'true'
        run: |
          ISSUE_BODY=$(cat /tmp/issue-body.txt)
          PROMPT=$(cat .agent-system/agent-prompts/performance.md)
          printf '%s\n\n---\nCONTEXT:\nISSUE_NUMBER=%s\nISSUE_TITLE=%s\nREPO=%s\nFEATURE_BRANCH=%s\nPR_NUMBER=%s\nMODE=perf\n\nISSUE BODY:\n%s\n' \
            "${PROMPT}" "${ISSUE_NUMBER}" "${ISSUE_TITLE}" "${REPO}" "${FEATURE_BRANCH}" "${PR_NUMBER}" \
            "${ISSUE_BODY}" > /tmp/perf-full-prompt.txt
          set +e
          claude --model claude-haiku-4-5 --max-turns 15 -p "$(cat /tmp/perf-full-prompt.txt)" > /tmp/validation-report.txt 2>&1
          CLAUDE_EXIT=$?
          set -e
          echo "=== Performance Agent Output ==="
          cat /tmp/validation-report.txt
          echo "=== Claude exit code: ${CLAUDE_EXIT} ==="
          if [ "${CLAUDE_EXIT}" -ne 0 ]; then exit ${CLAUDE_EXIT}; fi
          SRC_MODIFIED=$(git diff --name-only HEAD | grep '^src/' || true)
          if [ -n "${SRC_MODIFIED}" ]; then
            echo "FAIL: Performance agent modified production files — PROHIBITED"
            exit 1
          fi
          if grep -q "Status: FAIL" /tmp/validation-report.txt; then
            echo "PERF_DECISION=FAIL" >> "${GITHUB_ENV}"
          else
            echo "PERF_DECISION=PASS" >> "${GITHUB_ENV}"
          fi

      - name: Post performance SKIP comment
        if: inputs.mode == 'perf' && steps.perf-check.outputs.has_perf_criteria == 'false'
        run: |
          gh pr comment "${PR_NUMBER}" \
            --repo "${REPO}" \
            --body "## Performance Agent Report
Status: SKIP

No performance criteria detected in issue #${ISSUE_NUMBER}. Performance validation skipped."
          echo "Performance validation skipped — no criteria in issue"

      - name: Post performance report comment
        if: inputs.mode == 'perf' && steps.perf-check.outputs.has_perf_criteria == 'true'
        run: |
          printf '## Performance Agent Report\n\n%s' "$(cat /tmp/validation-report.txt)" > /tmp/perf-comment.txt
          gh pr comment "${PR_NUMBER}" \
            --repo "${REPO}" \
            --body-file /tmp/perf-comment.txt
          if [ "${PERF_DECISION}" = "FAIL" ]; then
            echo "Performance criteria not met — failing step to block pipeline"
            exit 1
          fi
